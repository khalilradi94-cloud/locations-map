<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buy Food with Plastic — Locations</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #fff;
    }

    header {
      padding: 16px 20px;
      border-bottom: 1px solid #eee;
    }

    header h1 {
      margin: 0;
      font-size: 18px;
    }

    header p {
      margin: 6px 0 0;
      color: #555;
      font-size: 14px;
    }

    .wrap {
      display: grid;
      grid-template-columns: 420px 1fr;
      height: calc(100vh - 74px);
    }

    .sidebar {
      border-right: 1px solid #eee;
      overflow: auto;
      padding: 14px;
    }

    .controls {
      display: grid;
      gap: 10px;
      margin-bottom: 12px;
    }

    .controls label {
      font-size: 12px;
      color: #555;
    }

    .controls select,
    .controls input {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 14px;
      width: 100%;
    }

    .count {
      font-size: 12px;
      color: #666;
      margin: 6px 0 12px;
    }

    .card {
      border: 1px solid #eee;
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 10px;
      cursor: pointer;
    }

    .card:hover {
      border-color: #ddd;
    }

    .activeCard {
      border-color: #bbb;
      box-shadow: 0 6px 20px rgba(0,0,0,.06);
    }

    .badge {
      display: inline-block;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #f3f3f3;
      margin-right: 6px;
    }

    .meta {
      color: #666;
      font-size: 12px;
      margin-top: 6px;
    }

    .desc {
      color: #333;
      font-size: 13px;
      margin-top: 8px;
      line-height: 1.35;
    }

    #map {
      height: 100%;
    }

    @media (max-width: 980px) {
      .wrap {
        grid-template-columns: 1fr;
        grid-template-rows: 44vh 1fr;
      }
      .sidebar {
        border-right: none;
        border-top: 1px solid #eee;
      }
    }
  </style>
</head>
<body>

<header>
  <h1>Locations</h1>
  <p>Headquarters, collection points, buyers, impacted regions and active communities.</p>
</header>

<div class="wrap">
  <div id="map"></div>

  <aside class="sidebar">
    <div class="controls">
      <div>
        <label>Type</label>
        <select id="type">
          <option value="ALL">All</option>
          <option value="HQ">Headquarters</option>
          <option value="COLLECTION_POINT">Collection points</option>
          <option value="BUYER">Buyers</option>
          <option value="IMPACTED_REGION">Impacted regions</option>
          <option value="ACTIVE_COMMUNITY">Active communities</option>
        </select>
      </div>

      <div>
        <label>Country</label>
        <select id="country">
          <option value="ALL">All</option>
        </select>
      </div>

      <div>
        <label>Search</label>
        <input id="q" placeholder="Search location..." />
      </div>
    </div>

    <div class="count" id="count"></div>
    <div id="list"></div>
  </aside>
</div>

<script>
  const TYPE_LABEL = {
    HQ: "Headquarters",
    COLLECTION_POINT: "Collection point",
    BUYER: "Buyer",
    IMPACTED_REGION: "Impacted region",
    ACTIVE_COMMUNITY: "Active community"
  };

  const map = L.map("map").setView([20, 0], 2);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "© OpenStreetMap contributors"
  }).addTo(map);

  let all = [];
  let markers = new Map();
  let activeId = null;

  function norm(s) {
    return (s || "").toLowerCase();
  }

  function getFilters() {
    return {
      type: document.getElementById("type").value,
      country: document.getElementById("country").value,
      q: norm(document.getElementById("q").value)
    };
  }

  function matches(item, f) {
    if (f.type !== "ALL" && item.type !== f.type) return false;
    if (f.country !== "ALL" && item.country !== f.country) return false;

    if (f.q) {
      const hay = [
        item.name,
        item.city,
        item.region,
        item.country,
        item.description
      ].map(norm).join(" ");
      if (!hay.includes(f.q)) return false;
    }
    return true;
  }

  function setActive(id) {
    activeId = id;

    document.querySelectorAll(".card").forEach(c => {
      c.classList.toggle("activeCard", c.dataset.id === id);
    });

    const m = markers.get(id);
    if (m) {
      map.setView(m.getLatLng(), Math.max(map.getZoom(), 6));
      m.openPopup();
    }
  }

  function render(filtered) {
    const list = document.getElementById("list");
    const count = document.getElementById("count");

    count.textContent = filtered.length + " result(s)";
    list.innerHTML = "";

    markers.forEach(m => map.removeLayer(m));
    markers.clear();

    filtered.forEach(item => {
      const card = document.createElement("div");
      card.className = "card";
      card.dataset.id = item.id;

      card.innerHTML = `
        <div>
          <span class="badge">${TYPE_LABEL[item.type] || item.type}</span>
          <span class="badge">${item.status}</span>
        </div>
        <div style="margin-top:8px;font-weight:600">${item.name}</div>
        <div class="meta">${[item.city, item.region, item.country].filter(Boolean).join(", ")}</div>
        <div class="desc">${item.description || ""}</div>
      `;

      card.onclick = () => setActive(item.id);
      list.appendChild(card);

      if (typeof item.lat === "number" && typeof item.lng === "number") {
        const marker = L.marker([item.lat, item.lng])
          .addTo(map)
          .bindPopup(`<strong>${item.name}</strong><br>${item.country}`);
        marker.on("click", () => setActive(item.id));
        markers.set(item.id, marker);
      }
    });
  }

  function apply() {
    const f = getFilters();
    const filtered = all.filter(i => matches(i, f));
    render(filtered);
  }

  async function init() {
    const res = await fetch("./locations.json");
    all = await res.json();

    const countries = [...new Set(all.map(i => i.country))];
    const sel = document.getElementById("country");
    countries.forEach(c => {
      const o = document.createElement("option");
      o.value = c;
      o.textContent = c;
      sel.appendChild(o);
    });

    document.getElementById("type").onchange = apply;
    document.getElementById("country").onchange = apply;
    document.getElementById("q").oninput = apply;

    apply();
  }

  init();
</script>

</body>
</html>
